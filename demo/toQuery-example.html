<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Using `form.toQuery()`</title>
    <link rel="stylesheet" href="./style.css">
    <script src="../dist/form-default.js" type="module"></script>
    <style>
        .query-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .query-actions button {
            background-color: var(--brand-color);
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            padding: 10px 18px;
            transition: filter 0.2s ease-out;
        }

        .query-actions button:hover {
            filter: brightness(1.1);
        }

        .query-output {
            min-height: 220px;
            white-space: pre-wrap;
        }

        .query-layout {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .form-wrapper,
        .query-wrapper,
        .results-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
        }

        .results-output {
            min-height: 220px;
            overflow-x: auto;
            padding: 0 4px;
        }

        .results-output table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.9em;
        }

        .results-output th,
        .results-output td {
            border: 1px solid #d1d1d1;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }

        .results-output tbody tr:nth-child(even) {
            background-color: #f6f6f6;
        }

        .results-output a {
            color: inherit;
            text-decoration: none;
        }

        .results-output a:hover {
            text-decoration: underline;
        }

        #instructions {
            display: block;
        }

        #instructions ul {
            margin: 0;
            padding-left: 1.5em;
        }

        #instructions li {
            margin: 0.4em 0;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Using <code>form.toQuery()</code></h1>
    </div>
    <nav class="menu">
        <a href="index.html#intro">« Back to demo</a>
        <a href="#instructions">How it works</a>
    </nav>
    <div class="main">
        <div class="content">
            <p>This page demonstrates how the local <code>toQuery()</code> implementation converts populated SHACL forms
                into reusable SPARQL queries.</p>
            <div class="wrapper query-layout">
                <fieldset>
                    <legend>SHACL Form</legend>
                    <div class="form-wrapper">
                        <shacl-form id="example-form"></shacl-form>
                        <div class="query-actions">
                            <button type="button" onclick="generateConstructQuery()">Generate CONSTRUCT query</button>
                            <button type="button" onclick="runSelectQuery()">Run SELECT against DBpedia</button>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Generated SPARQL Query</legend>
                    <div class="query-wrapper">
                        <pre id="query-output" class="query-output">Click a button to generate a query...</pre>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Live Results (dbpedia.org)</legend>
                    <div class="results-wrapper">
                        <div id="results-output" class="results-output">SELECT queries will display up to 15 matches
                            here.</div>
                    </div>
                </fieldset>
            </div>
            <fieldset id="instructions">
                <legend>How it works</legend>
                <ul>
                    <li>The shape targets <code>dbo:Person</code> resources on the public DBpedia endpoint.</li>
                    <li>Enter any combination of name, nationality, or occupation; unfilled fields remain OPTIONAL in
                        the generated query.</li>
                    <li>Name and nationality inputs use lenient mode (trimmed, case-insensitive CONTAINS filters) while
                        occupation stays a controlled list.</li>
                    <li><strong>Generate CONSTRUCT</strong> shows the base query; <strong>Run SELECT</strong> executes
                        the same WHERE clause against https://dbpedia.org/sparql with a built-in LIMIT 15.</li>
                    <li>DBpedia may throttle rapid requests; if you see an error, wait a moment and try again.</li>
                </ul>
            </fieldset>
        </div>
        <div class="footer">
            <a href="https://github.com/ULB-Darmstadt/shacl-form"><img alt="GitHub Logotype" src="./github-mark.png"
                    height="64"></a>
            <a href="https://www.npmjs.com/package/@ulb-darmstadt/shacl-form">
                <img src="https://img.shields.io/npm/v/@ulb-darmstadt/shacl-form.svg" alt="Version">
            </a>
        </div>
    </div>

    <script>
        const form = document.getElementById('example-form')
        const output = document.getElementById('query-output')
        const results = document.getElementById('results-output')

        const shapesTurtle = String.raw`
@prefix sh:   <http://www.w3.org/ns/shacl#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix dbo:  <http://dbpedia.org/ontology/> .
@prefix dbp:  <http://dbpedia.org/property/> .
@prefix dbr:  <http://dbpedia.org/resource/> .
@prefix xsd:  <http://www.w3.org/2001/XMLSchema#> .

dbo:PersonSearchShape
    a sh:NodeShape, rdfs:Class ;
    sh:targetClass dbo:Person ;
    sh:property [
        sh:name "Name (partial match, en)" ;
        sh:datatype rdf:langString ;
        sh:path dbp:name ;
        sh:maxCount 1 ;
        sh:languageIn ( "en" ) ;
    ] ;
    sh:property [
        sh:name "Nationality (partial match, en)" ;
        sh:path dbp:nationality ;
        sh:datatype rdf:langString ;
        sh:maxCount 1 ;
        sh:languageIn ( "en" ) ;
    ] ;
    sh:property [
        sh:name "Occupation" ;
        sh:path dbo:occupation ;
        sh:in (
            dbr:Actor
            dbr:Painter
            dbr:Software_engineer
            dbr:Musician
            dbr:Chemist
        ) ;
    ] ;
    .
`

        form.dataset.shapes = shapesTurtle

        function generateConstructQuery() {
            try {
                const query = form.toQuery({
                    lenient: true
                })
                output.textContent = query
            } catch (error) {
                output.textContent = 'Error: ' + error.message
            }
        }

        async function runSelectQuery() {
            try {
                const query = form.toQuery({
                    type: 'select',
                    distinct: true,
                    lenient: true,
                    limit: 15
                })
                output.textContent = query
                results.innerHTML = '<p>Running query against DBpedia…</p>'

                const response = await fetch('https://dbpedia.org/sparql', {
                    method: 'POST',
                    headers: {
                        'content-type': 'application/sparql-query',
                        accept: 'application/sparql-results+json'
                    },
                    body: query
                })

                if (!response.ok) {
                    throw new Error(`Endpoint returned ${response.status} ${response.statusText}`)
                }

                const data = await response.json()
                renderResults(data)
            } catch (error) {
                output.textContent = 'Error: ' + error.message
                results.innerHTML = `<p>Query failed: ${escapeHtml(error.message)}</p>`
            }
        }

        function renderResults(data) {
            const vars = (data.head && Array.isArray(data.head.vars)) ? data.head.vars : []
            const bindings = (data.results && Array.isArray(data.results.bindings)) ? data.results.bindings : []

            if (!vars.length) {
                results.innerHTML = '<p>No variables returned.</p>'
                return
            }

            if (!bindings.length) {
                results.innerHTML = '<p>No matches found.</p>'
                return
            }

            const limited = bindings.slice(0, 15)
            const header = vars.map((name) => `<th>${escapeHtml(name)}</th>`).join('')
            const rows = limited
                .map((binding) => `<tr>${vars.map((name) => `<td>${formatBinding(binding[name])}</td>`).join('')}</tr>`)
                .join('')

            results.innerHTML = `
                <table>
                    <thead><tr>${header}</tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `
        }

        function formatBinding(binding) {
            if (!binding) {
                return ''
            }

            if (binding.type === 'uri') {
                const href = escapeHtml(binding.value)
                return `<a href="${href}" target="_blank" rel="noopener">${href}</a>`
            }

            const suffix = binding['xml:lang'] ? `@${escapeHtml(binding['xml:lang'])}` : binding.datatype ? `^^${escapeHtml(binding.datatype)}` : ''
            return `${escapeHtml(binding.value)}${suffix}`
        }

        function escapeHtml(value) {
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;')
        }
    </script>
</body>

</html>